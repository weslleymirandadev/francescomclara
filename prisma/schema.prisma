// ---------- PRISMA CONFIG ----------
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// -----------------------------------
// USERS & AUTH
// -----------------------------------

model User {
  id              String           @id @default(cuid())
  name            String?
  email           String?          @unique
  passwords       UserPassword?
  image           String?
  role            UserRole         @default(USER)

  accounts        Account[]
  sessions        Session[]

  enrollments     Enrollment[]
  lessonProgresses LessonProgress[]

  coursePosts     CoursePost[]
  forumPosts      ForumPost[]
  forumComments   ForumComment[]

  payments        Payment[]

  coursesOwned    Course[]         @relation("CourseInstructor")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model UserPassword {
  id        String   @id @default(uuid())
  userId    String   @unique
  hash      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum UserRole {
  USER
  INSTRUCTOR
  MODERATOR
  ADMIN
}

model RoleEmail {
  id        String   @id @default(cuid())
  email     String   @unique
  role      UserRole
  createdAt DateTime @default(now())
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  user               User    @relation(fields: [userId], references: [id])
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  expires      DateTime

  createdAt    DateTime @default(now())
}

// -----------------------------------
// COURSES (SEM TURMAS)
// -----------------------------------

model Course {
  id            String       @id @default(cuid())
  title         String
  description   String
  imageUrl      String?
  price         Int?

  modules       Module[]
  posts         CoursePost[]
  forumPosts    ForumPost[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  instructorId  String?
  instructor    User?     @relation("CourseInstructor", fields: [instructorId], references: [id])

  enrollments   Enrollment[]
  payments      Payment[]
}

model Module {
  id        String   @id @default(cuid())
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  title     String
  order     Int

  lessons   Lesson[]
}

model Lesson {
  id        String   @id @default(cuid())
  moduleId  String
  module    Module   @relation(fields: [moduleId], references: [id])
  title     String
  content   Json
  order     Int

  progress  LessonProgress[]
}

model LessonProgress {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  completed Boolean  @default(false)

  user      User     @relation(fields: [userId], references: [id])
  lesson    Lesson   @relation(fields: [lessonId], references: [id])

  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId])
}

// -----------------------------------
// ENROLLMENTS (CURSO → VITALÍCIO / JORNADA → EXPIRAÇÃO)
// -----------------------------------

model Enrollment {
  id          String     @id @default(cuid())
  userId      String
  courseId    String?
  journeyId   String?
  startDate   DateTime    @default(now())
  endDate     DateTime?

  user        User        @relation(fields: [userId], references: [id])
  course      Course?     @relation(fields: [courseId], references: [id])
  journey     Journey?    @relation(fields: [journeyId], references: [id])

  createdAt   DateTime    @default(now())

  @@unique([userId, courseId])
  @@unique([userId, journeyId])
}

// -----------------------------------
// CONTENT POSTS
// -----------------------------------

model CoursePost {
  id        String   @id @default(cuid())
  courseId  String
  authorId  String
  content   Json
  isPinned  Boolean @default(false)

  course    Course @relation(fields: [courseId], references: [id])
  author    User   @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
}

// -----------------------------------
// JOURNEYS
// -----------------------------------

model Journey {
  id          String         @id @default(cuid())
  title       String
  description String
  price       Int?

  modules     JourneyModule[]
  forumPosts  ForumPost[]
  enrollments Enrollment[]

  payments Payment[]
}

model JourneyModule {
  id         String        @id @default(cuid())
  journeyId  String
  journey    Journey       @relation(fields: [journeyId], references: [id])
  title      String
  order      Int

  lessons    JourneyLesson[]
}

model JourneyLesson {
  id         String        @id @default(cuid())
  moduleId   String
  module     JourneyModule @relation(fields: [moduleId], references: [id])
  title      String
  content    Json
  order      Int
}

// -----------------------------------
// FORUM
// -----------------------------------

model ForumPost {
  id          String    @id @default(cuid())
  authorId    String
  title       String
  content     Json

  cursoId     String?
  jornadaId   String?

  author      User       @relation(fields: [authorId], references: [id])
  curso       Course?    @relation(fields: [cursoId], references: [id])
  jornada     Journey?   @relation(fields: [jornadaId], references: [id])

  comments    ForumComment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ForumComment {
  id        String   @id @default(cuid())
  postId    String
  authorId  String
  content   Json

  post      ForumPost @relation(fields: [postId], references: [id])
  author    User      @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
}

// -----------------------------------
// PAYMENTS (AGORA ITEM GENÉRICO)
// -----------------------------------

model Payment {
  id           String   @id @default(cuid())
  userId       String
  itemType     PaymentItemType
  courseId     String?
  journeyId    String?
  mpPaymentId  String   @unique
  status       String
  amount       Int

  user         User     @relation(fields: [userId], references: [id])
  course       Course?  @relation(fields: [courseId], references: [id])
  journey      Journey? @relation(fields: [journeyId], references: [id])

  createdAt    DateTime @default(now())

  @@index([itemType])
  refunds Refund[]
}

enum PaymentItemType {
  COURSE
  JOURNEY
}

model Refund {
  id          String   @id @default(cuid())
  paymentId   String
  mpRefundId  String?  // id do reembolso no MP
  status      String   // pending, approved, rejected
  amount      Int
  createdAt   DateTime @default(now())

  payment     Payment  @relation(fields: [paymentId], references: [id])

  @@index([paymentId])
}